<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSU Valve Controller</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            margin: 20px;
            transition: background-color 0.3s, color 0.3s;
            max-width: 100%; /* Ensures content doesn't overflow on small screens */
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .active, .collapsible:hover {
            background-color: #ccc;
        }

        .active, .collapsible:hover {
            background-color: #484848;
        }

        h1 {
            color: #333;
        }
        
        h2 {
            margin: 10px;
        }

        h1.dark-mode {
            color: #0d7760;
        }

        #boxes-container {
            display: flex;
            flex-wrap: wrap;  /* This ensures boxes wrap to the next row when there's not enough space */
            justify-content: flex-start;  /* This positions the boxes to the left */
        }

        .dac-box {
            border: 2px solid #007bff;
            padding: 10px;
            margin: 10px;
            max-width: 200px;
        }

        form {
            margin-bottom: 10px;
            display:inline-block;
            margin-top: 10px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            position: relative;
            left: 20px;
        }

        input[type="range"] {
            width: 10%;
            position: relative;
            appearance: slider-vertical;
            left: 37px;
        }

        button {
        padding: 10px;
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        margin-right: 10px;
        display:inline;
        margin: 0 auto;
        }

        button.set {
            position: relative;
            top: -61px;
            right: -64px;
            width: 50px;
        }
        
        button.open {
            position: relative;
            top: -107px;
            right: 45px;
            width: 50px;
        }
        
        button.close {
            position: relative;
            top: -14px;
            left: 9.5px;
            width: 50px;
        }

        #settings-button,
        #dark-mode-button {
            position: fixed;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            z-index: 2;
            transform: scale(2);
        }

        #settings-button {
            top: 20px;
            right: 104px;
        }

        #dark-mode-button {
            top: 20px;
            right: 20px;
        }

        /* Mobile */
        @media only screen and (max-width: 600px) {
            body {
                margin: 10px; /* Adjust margin for smaller screens */
            }

            .dac-box {
                width: calc(100% - 20px); /* Set box width to nearly full width with some margin */
                margin-bottom: 20px; /* Add some spacing between boxes */
                font-size: 18px; /* Increase font size for better readability */
                padding: 20px; /* Add padding for better spacing inside boxes */
            }

            h2 {
                font-size: 24px; /* Increase font size for better readability */
                margin: 10px 0; /* Add some vertical margin for better spacing */
            }

            /* Adjust input range width for smaller screens */
            input[type="range"] {
                width: 80%;
                left: 10%;
            }

            /* Adjust button positioning for smaller screens */
            button.set, button.open, button.close {
                position: relative;
                top: 0;
                right: 0;
                width: 100%;
                margin-top: 10px; /* Add some margin between buttons */
            }

            /* Adjust settings and dark mode buttons for smaller screens */
            #settings-button {
                top: 10px;
                right: 10px;
            }

            #dark-mode-button {
                top: 10px;
                right: 70px;
            }
        }
    </style>
    <script>
        // Function to handle form submissions asynchronously
        function submitForm(event, url) {
            console.log('Form submitted:', url, event);
            event.preventDefault(); // Prevent default form submission behavior
            let formData = new FormData(event.target);
            console.log(formData); // Move this statement here
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // Handle the response from the Flask server if needed
                console.log('Form submitted successfully!');
            })
            .catch(error => {
                // Handle any errors that occurred during the fetch
                console.error('Error submitting form:', error);
            });
        }

        function sendPostRequest(url) {
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // Add any payload if required
            })
            .then(response => {
                // Handle the response as needed
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        // Function to navigate to the settings page
        function goToSettings() {
            window.location.href = '/settings';
        }

        // Function to toggle dark mode
        function toggleDarkMode() {
        const h1 = document.querySelector('h1');
        h1.classList.toggle('dark-mode'); // Toggle the dark-mode class on the body
        const body = document.body;
        body.classList.toggle('dark-mode'); 

        // Toggle the symbols based on the mode
        const lightModeSymbol = 'üí°';
        const darkModeSymbol = 'üåô';
        const toggleButton = document.getElementById('dark-mode-button');
        const currentSymbol = toggleButton.textContent;

        toggleButton.textContent = currentSymbol === lightModeSymbol ? darkModeSymbol : lightModeSymbol;

        // You can also save the user's preference for dark mode in local storage
        const isDarkModeEnabled = body.classList.contains('dark-mode');
        localStorage.setItem('darkMode', isDarkModeEnabled);
    }

    document.addEventListener('DOMContentLoaded', function () {
    // Set initial dark mode based on user's preference in local storage
    const isDarkModeEnabled = localStorage.getItem('darkMode') === 'true';
    const body = document.body;
    body.classList.toggle('dark-mode', isDarkModeEnabled);
    
    const h1 = document.querySelector('h1');
    h1.classList.toggle('dark-mode', isDarkModeEnabled);

    const toggleButton = document.getElementById('dark-mode-button');
    toggleButton.textContent = isDarkModeEnabled ? 'üåô' : 'üí°';
});


    </script>
    <link href="/static/favicon.ico" rel="icon" type="image/x-icon">
</head>
<body>
    <h1>DAC Control Interface</h1>

    <div id="boxes-container">
        {% for dac_id, dac in dac_objects.items() if dac_id.startswith('0x') %}
            <div class="dac-box">
                <!-- Display DAC Name or "Unnamed DAC" -->
                <h2>{{ dac.name or "Unnamed DAC" }}</h2>
            
            <!-- Form to set voltage for Channel 1 -->
            <form onsubmit="submitForm(event, '/set_voltage{{ dac_id }}')" method="post">
                <label for="voltage_{{ dac_id }}">Voltage (0-100%):</label>
                <input type="range" id="voltage_{{ dac_id }}" name="voltage" min="0" max="100" step=".1">
                <button class="set" type="submit">Set</button>
                
            
            
            <!-- Open and close the channels -->
            <button class="close" onclick="sendPostRequest('/close1{{ dac_id }}')">Close</button>
            <button class="open" onclick="sendPostRequest('/open1{{ dac_id }}')">Open</button>
        </form>
        </div>
    {% endfor %}

    
    <!-- Settings button in the top right -->
    <div id="settings-button" onclick="goToSettings()">
        ‚öôÔ∏è
    </div>

    <!-- Dark mode button -->
    <div id="dark-mode-button" onclick="toggleDarkMode()">
        üåô
    </div>
</body>
</html>